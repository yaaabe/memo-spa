<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒª (ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ)</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 720px; margin: 24px auto; padding: 0 12px; }
    h1 { margin-bottom: 8px; }
    form { display: grid; gap: 8px; margin: 16px 0; }
    input, textarea, button { padding: 8px; font-size: 14px; }
    ul { list-style: none; padding: 0; }
    li { border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin: 8px 0; }
    .meta { color: #666; font-size: 12px; margin-top: 4px; }
    .row { display:flex; gap:8px; margin-top:8px; }
  </style>
</head>
<body>
  <h1>ğŸ“ ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒªï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ï¼‰</h1>

  <section>
    <h2>æ–°è¦ãƒ¡ãƒ¢</h2>
    <form id="create-form">
      <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰" required />
      <textarea id="content" rows="3" placeholder="æœ¬æ–‡ï¼ˆä»»æ„ï¼‰"></textarea>
      <button type="submit">è¿½åŠ </button>
    </form>
  </section>

  <section>
    <h2>ãƒ¡ãƒ¢ä¸€è¦§</h2>
    <ul id="list"></ul>
  </section>

<template id="item-tpl">
  <li>
    <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
    <div class="view">
      <strong class="title"></strong>
      <div class="content"></div>
      <div class="meta"></div>
      <div class="row">
        <button class="edit">ç·¨é›†</button>
        <button class="delete">å‰Šé™¤</button>
      </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰ -->
    <form class="edit-form" style="display:none; gap:8px; margin-top:8px;">
      <input class="edit-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" />
      <textarea class="edit-content" rows="3" placeholder="æœ¬æ–‡"></textarea>
      <div class="row">
        <button type="submit" class="save">ä¿å­˜</button>
        <button type="button" class="cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </form>
  </li>
</template>


  <script>
    const $  = (s, el=document) => el.querySelector(s);

    // ä¸€è¦§å–å¾— â†’ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    async function fetchNotes() {
      const res = await fetch('/api/notes');            // åŒã˜ã‚ªãƒªã‚¸ãƒ³ãªã®ã§CORSä¸è¦
      const notes = await res.json();
      render(notes);
    }

function render(notes) {
  const list = $('#list');
  list.innerHTML = '';
  for (const n of notes) {
    const li = document.importNode($('#item-tpl').content, true);

    // è¡¨ç¤ºãƒ‘ãƒ¼ãƒ„
    const view = li.querySelector('.view');
    li.querySelector('.title').textContent   = n.title;
    li.querySelector('.content').textContent = n.content || '';
    li.querySelector('.meta').textContent    = `#${n.id}  ä½œæˆ:${n.createdAt}  æ›´æ–°:${n.updatedAt}`;

    // ç·¨é›†ãƒ‘ãƒ¼ãƒ„
    const form = li.querySelector('.edit-form');
    const titleInput = li.querySelector('.edit-title');
    const contentInput = li.querySelector('.edit-content');

    // ç·¨é›†é–‹å§‹ï¼ˆè¡¨ç¤ºâ†’ç·¨é›†ã«åˆ‡æ›¿ï¼‰
    li.querySelector('.edit').addEventListener('click', () => {
      titleInput.value = n.title;
      contentInput.value = n.content || '';
      view.style.display = 'none';
      form.style.display = 'grid';
    });

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆç·¨é›†â†’è¡¨ç¤ºã«æˆ»ã™ï¼‰
    li.querySelector('.cancel').addEventListener('click', () => {
      form.style.display = 'none';
      view.style.display = '';
    });

    // ä¿å­˜ï¼ˆPUTï¼‰
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const newTitle = titleInput.value.trim();
      const newContent = contentInput.value.trim();
      if (!newTitle) return alert('ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™');

      const res = await fetch(`/api/notes/${n.id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: newTitle, content: newContent })
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        alert('æ›´æ–°ã«å¤±æ•—: ' + (err.error || res.status));
        return;
      }
      fetchNotes(); // å†æç”»ï¼ˆç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã¯æ¶ˆãˆã¦æœ€æ–°è¡¨ç¤ºã«ï¼‰
    });

    // æ—¢å­˜ï¼šå‰Šé™¤ãƒœã‚¿ãƒ³
    li.querySelector('.delete').addEventListener('click', async () => {
      const ok = confirm(`æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (id: ${n.id})`);
      if (!ok) return;
      await fetch(`/api/notes/${n.id}`, { method: 'DELETE' });
      fetchNotes();
    });

    list.appendChild(li);
  }
}




    // ä½œæˆãƒ•ã‚©ãƒ¼ãƒ 
    $('#create-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title   = $('#title').value.trim();
      const content = $('#content').value.trim();
      if (!title) return alert('ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™');
      await fetch('/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, content })
      });
      // å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ & å†å–å¾—
      $('#title').value = '';
      $('#content').value = '';
      fetchNotes();
    });

    // åˆå›ãƒ­ãƒ¼ãƒ‰
    fetchNotes();
  </script>
</body>
</html>
